<div class="p-6 h-full overflow-y-auto bg-neutral-900 text-white" [ngStyle]="{'border-color': theme().primary, 'color': theme().primary}">

  <!-- Not Authenticated View -->
  <div *ngIf="!isAuthenticated()" class="max-w-md mx-auto bg-neutral-800 p-8 rounded-lg shadow-lg">
    <h2 class="text-3xl font-bold text-center mb-2" [style.color]="theme().primary">{{ authMode() === 'login' ? 'Login to S.M.U.V.E.' : 'Register for S.M.U.V.E.' }}</h2>
    <p class="text-center text-neutral-400 mb-6">Access your personalized studio.</p>
    
    <!-- Auth Forms -->
    <form *ngIf="authMode() === 'login'" (ngSubmit)="handleLogin()">
      <div class="mb-4">
        <label for="login-email" class="block mb-2 text-sm font-medium text-neutral-300">Email</label>
        <input id="login-email" type="email" [value]="loginEmail()" (input)="loginEmail.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
      </div>
      <div class="mb-6">
        <label for="login-password" class="block mb-2 text-sm font-medium text-neutral-300">Password</label>
        <input id="login-password" type="password" [value]="loginPassword()" (input)="loginPassword.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
      </div>
      <button type="submit" class="w-full py-2 px-4 font-bold rounded-md text-white transition-colors" [style.background-color]="theme().primary" [disabled]="authLoading()">
        {{ authLoading() ? 'Logging in...' : 'Login' }}
      </button>
    </form>

    <form *ngIf="authMode() === 'register'" (ngSubmit)="handleRegister()">
        <div class="mb-4">
          <label for="register-artist-name" class="block mb-2 text-sm font-medium text-neutral-300">Artist Name</label>
          <input id="register-artist-name" type="text" [value]="registerArtistName()" (input)="registerArtistName.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
        </div>
        <div class="mb-4">
            <label for="register-email" class="block mb-2 text-sm font-medium text-neutral-300">Email</label>
            <input id="register-email" type="email" [value]="registerEmail()" (input)="registerEmail.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
        </div>
        <div class="mb-4">
            <label for="register-password" class="block mb-2 text-sm font-medium text-neutral-300">Password</label>
            <input id="register-password" type="password" [value]="registerPassword()" (input)="registerPassword.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
        </div>
        <div class="mb-6">
            <label for="register-confirm-password" class="block mb-2 text-sm font-medium text-neutral-300">Confirm Password</label>
            <input id="register-confirm-password" type="password" [value]="registerConfirmPassword()" (input)="registerConfirmPassword.set($event.target.value)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
        </div>
        <button type="submit" class="w-full py-2 px-4 font-bold rounded-md text-white transition-colors" [style.background-color]="theme().primary" [disabled]="authLoading()">
            {{ authLoading() ? 'Registering...' : 'Register' }}
        </button>
    </form>

    <!-- Auth Messages -->
    <div *ngIf="authError()" class="mt-4 p-3 bg-red-500/20 text-red-400 border border-red-500/30 rounded-md">
      {{ authError() }}
    </div>
    <div *ngIf="authSuccess()" class="mt-4 p-3 bg-green-500/20 text-green-400 border border-green-500/30 rounded-md">
      {{ authSuccess() }}
    </div>

    <!-- Toggle Auth Mode -->
    <div class="mt-6 text-center">
        <button (click)="authMode.set(authMode() === 'login' ? 'register' : 'login')" class="text-sm hover:underline" [style.color]="theme().accent">
            {{ authMode() === 'login' ? 'Need an account? Register' : 'Already have an account? Login' }}
        </button>
    </div>
  </div>

  <!-- Authenticated View -->
  <div *ngIf="isAuthenticated() && currentUser() as user">
    <!-- First Time User Intro -->
    <div *ngIf="profileCompleteness() < 100" class="bg-neutral-800 p-6 rounded-lg shadow-lg mb-8 border" [style.border-color]="theme().primary">
      <h2 class="text-3xl font-bold mb-2" [style.color]="theme().primary">Welcome to S.M.U.V.E. 2.0, {{ user.artistName }}!</h2>
      <p class="text-neutral-300 mb-4">Let's build your artist profile. The more S.M.U.V.E. knows about you, the better it can assist your creative journey. Fill out the sections below to unlock the full power of your AI partner.</p>
      <div class="w-full bg-neutral-700 rounded-full h-4">
        <div class="h-4 rounded-full transition-all duration-500" [style.width.%]="profileCompleteness()" [style.background-color]="theme().primary"></div>
      </div>
      <p class="text-right text-sm mt-1" [style.color]="theme().accent">{{ profileCompleteness() | number:'1.0-0' }}% Complete</p>
    </div>

    <!-- Main Profile View -->
    <div class="flex gap-8">
      <!-- Sidebar Menu -->
      <div class="w-1/4 sticky top-0 self-start">
        <div class="bg-neutral-800 p-4 rounded-lg shadow-lg">
            <div class="text-center mb-4">
              <div class="relative inline-block">
                <img [src]="editableProfile().profilePictureUrl || 'https://picsum.photos/seed/default-avatar/200'" alt="Artist Avatar" class="w-32 h-32 rounded-full mx-auto border-4" [style.border-color]="theme().primary">
                <label for="avatar-upload" class="absolute bottom-0 right-0 bg-neutral-600 rounded-full p-2 cursor-pointer hover:bg-neutral-500">
                  <i class="fas fa-camera"></i>
                  <input id="avatar-upload" type="file" class="hidden" accept="image/*" (change)="onFileSelected($event)">
                </label>
              </div>
              <h3 class="text-2xl font-bold mt-3">{{ editableProfile().artistName }}</h3>
              <p class="text-sm text-neutral-400">{{ editableProfile().primaryGenre }}</p>
            </div>
          <nav class="flex flex-col gap-2">
            <button *ngFor="let section of sections" 
                    (click)="activeSection.set(section.id)" 
                    [class.active-section]="activeSection() === section.id" 
                    class="text-left p-3 rounded-md transition-colors text-neutral-300 hover:bg-neutral-700/50 flex items-center gap-3" 
                    [style.background-color]="activeSection() === section.id ? theme().primary + '30' : 'transparent'"
                    [style.border-left]="activeSection() === section.id ? '4px solid ' + theme().primary : '4px solid transparent'">
              <i class="fas text-lg w-6 text-center" [ngClass]="section.icon" [style.color]="theme().accent"></i>
              <span>{{ section.label }}</span>
            </button>
          </nav>
          <div class="mt-6">
            <button (click)="saveProfile()" class="w-full py-2 px-4 font-bold rounded-md text-white transition-colors flex items-center justify-center gap-2" [style.background-color]="theme().primary" [disabled]="saveStatus() === 'saving'">
              <i *ngIf="saveStatus() === 'idle'" class="fas fa-save"></i>
              <i *ngIf="saveStatus() === 'saving'" class="fas fa-spinner fa-spin"></i>
              <i *ngIf="saveStatus() === 'saved'" class="fas fa-check"></i>
              <span>{{ saveStatus() === 'idle' ? 'Save Profile' : (saveStatus() === 'saving' ? 'Saving...' : 'Saved!') }}</span>
            </button>
            <button (click)="handleLogout()" class="w-full mt-2 py-2 text-neutral-400 text-sm hover:underline">Logout</button>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="w-3/4">
        <div class="bg-neutral-800 p-8 rounded-lg shadow-lg">
          <ng-container *ngFor="let section of sections">
            <div *ngIf="activeSection() === section.id" class="animate-fade-in">
              <h3 class="text-2xl font-bold mb-6 flex items-center gap-3" [style.color]="theme().primary">
                <i class="fas" [ngClass]="section.icon"></i>
                {{ section.label }}
              </h3>

              <!-- Basic Info Section -->
              <div *ngIf="section.id === 'basic'" class="space-y-6">
                <app-form-field label="Artist Name" description="Your primary artist or band name.">
                  <input type="text" [value]="editableProfile().artistName" (input)="updateField('artistName', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
                </app-form-field>
                <app-form-field label="Stage Name (optional)" description="An alternate name you perform under.">
                  <input type="text" [value]="editableProfile().stageName" (input)="updateField('stageName', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
                </app-form-field>
                <app-form-field label="Location" description="City, State, Country. Helps with networking.">
                  <input type="text" [value]="editableProfile().location" (input)="updateField('location', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
                </app-form-field>
                <app-form-field label="Your Story / Bio" description="Tell S.M.U.V.E. about your journey, what drives you, your mission. Use your voice to dictate!">
                  <div class="relative">
                    <textarea rows="8" [value]="editableProfile().bio" (input)="updateField('bio', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary" placeholder="Describe your musical journey..."></textarea>
                    <button (click)="isRecording() && recordingField() === 'bio' ? stopVoiceInput() : startVoiceInput('bio')" class="absolute bottom-2 right-2 p-2 rounded-full transition-colors" [ngClass]="isRecording() && recordingField() === 'bio' ? 'bg-red-500 text-white' : 'bg-neutral-600 hover:bg-neutral-500'" [title]="isRecording() && recordingField() === 'bio' ? 'Stop Recording' : 'Start Voice Input'">
                      <i class="fas fa-microphone"></i>
                    </button>
                  </div>
                </app-form-field>
              </div>

              <!-- Musical Identity Section -->
              <div *ngIf="section.id === 'musical'" class="space-y-6">
                <app-form-field label="Primary Genre" description="Select the genre that best represents your core sound.">
                  <select [value]="editableProfile().primaryGenre" (change)="updateField('primaryGenre', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
                    <option *ngFor="let genre of ALL_GENRES" [value]="genre">{{ genre }}</option>
                  </select>
                </app-form-field>
                <app-form-field label="Secondary Genres" description="Other genres you frequently explore.">
                    <div class="grid grid-cols-3 gap-2">
                        <label *ngFor="let genre of ALL_GENRES" class="flex items-center gap-2 p-2 bg-neutral-700/50 rounded-md">
                            <input type="checkbox" [checked]="isArrayFieldChecked('secondaryGenres', genre)" (change)="updateArrayField('secondaryGenres', genre, $event)" class="accent-purple-500">
                            <span>{{ genre }}</span>
                        </label>
                    </div>
                </app-form-field>
                <app-form-field label="Describe Your Unique Sound" description="What makes your music stand out? What's your sonic signature? Dictate with your voice.">
                  <div class="relative">
                    <textarea rows="5" [value]="editableProfile().uniqueSound" (input)="updateField('uniqueSound', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary"></textarea>
                    <button (click)="isRecording() && recordingField() === 'uniqueSound' ? stopVoiceInput() : startVoiceInput('uniqueSound')" class="absolute bottom-2 right-2 p-2 rounded-full transition-colors" [ngClass]="isRecording() && recordingField() === 'uniqueSound' ? 'bg-red-500 text-white' : 'bg-neutral-600 hover:bg-neutral-500'">
                      <i class="fas fa-microphone"></i>
                    </button>
                  </div>
                </app-form-field>
                <app-form-field label="Musical Influences & Heroes" description="List artists, producers, movements, etc. that inspire you.">
                  <div class="relative">
                    <textarea rows="5" [value]="editableProfile().musicalInfluences" (input)="updateField('musicalInfluences', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary"></textarea>
                     <button (click)="isRecording() && recordingField() === 'musicalInfluences' ? stopVoiceInput() : startVoiceInput('musicalInfluences')" class="absolute bottom-2 right-2 p-2 rounded-full transition-colors" [ngClass]="isRecording() && recordingField() === 'musicalInfluences' ? 'bg-red-500 text-white' : 'bg-neutral-600 hover:bg-neutral-500'">
                      <i class="fas fa-microphone"></i>
                    </button>
                  </div>
                </app-form-field>
              </div>

              <!-- Experience & Skills Section -->
              <div *ngIf="section.id === 'expertise'" class="space-y-6">
                <app-form-field label="Your Skills" description="Select all skills you possess.">
                    <div class="grid grid-cols-3 gap-2">
                        <label *ngFor="let skill of ALL_SKILLS" class="flex items-center gap-2 p-2 bg-neutral-700/50 rounded-md">
                            <input type="checkbox" [checked]="isArrayFieldChecked('skills', skill)" (change)="updateArrayField('skills', skill, $event)" class="accent-purple-500">
                            <span>{{ skill }}</span>
                        </label>
                    </div>
                </app-form-field>
                <app-form-field label="Skill Levels" description="Rate your proficiency in your selected skills (1=Beginner, 10=Expert).">
                  <div class="space-y-4">
                    <div *ngFor="let skill of editableProfile().skills">
                      <label class="block mb-1">{{ skill }}</label>
                      <div class="flex items-center gap-4">
                        <input type="range" min="1" max="10" [value]="editableProfile().expertiseLevels?.[skill] || 5" (input)="updateExpertiseLevel(skill, $event)" class="w-full">
                        <span class="font-bold w-8 text-center" [style.color]="theme().accent">{{ editableProfile().expertiseLevels?.[skill] || 5 }}</span>
                      </div>
                    </div>
                  </div>
                </app-form-field>
                 <app-form-field label="Years of Experience" description="How long have you been actively making music?">
                    <input type="number" [value]="editableProfile().yearsExperience" (input)="updateField('yearsExperience', $event)" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md focus:outline-none focus:ring-2" [style.--tw-ring-color]="theme().primary">
                </app-form-field>
                <app-form-field label="Formal Training" description="Any music school, certifications, or mentorships?">
                  <div class="relative">
                    <textarea [value]="editableProfile().formalTraining" (input)="updateField('formalTraining', $event)" rows="3" class="w-full p-2 bg-neutral-700 border border-neutral-600 rounded-md"></textarea>
                     <button (click)="isRecording() && recordingField() === 'formalTraining' ? stopVoiceInput() : startVoiceInput('formalTraining')" class="absolute bottom-2 right-2 p-2 rounded-full" [ngClass]="isRecording() && recordingField() === 'formalTraining' ? 'bg-red-500' : 'bg-neutral-600'"><i class="fas fa-microphone"></i></button>
                  </div>
                </app-form-field>
              </div>
              
              <!-- Social & Links Section -->
              <div *ngIf="section.id === 'social'" class="space-y-4">
                <p class="text-neutral-400">Link your online presence so S.M.U.V.E. can analyze your brand and reach.</p>
                <h4 class="font-bold text-lg mt-6 mb-2">Social Media</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div *ngFor="let platform of socialPlatforms" class="flex items-center gap-2">
                    <label class="w-24">{{ platform }}</label>
                    <input type="text" [value]="editableProfile().links?.[platform] || ''" (input)="updateLinkField(platform, $event)" class="flex-grow p-2 bg-neutral-700 border-neutral-600 rounded-md">
                  </div>
                </div>
                <h4 class="font-bold text-lg mt-6 mb-2">Music Platforms</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div *ngFor="let platform of musicPlatforms" class="flex items-center gap-2">
                    <label class="w-24">{{ platform }}</label>
                    <input type="text" [value]="editableProfile().links?.[platform] || ''" (input)="updateLinkField(platform, $event)" class="flex-grow p-2 bg-neutral-700 border-neutral-600 rounded-md">
                  </div>
                </div>
                 <h4 class="font-bold text-lg mt-6 mb-2">PROs & Distribution</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div *ngFor="let platform of proPlatforms" class="flex items-center gap-2">
                    <label class="w-24">{{ platform }}</label>
                    <input type="text" [value]="editableProfile().links?.[platform] || ''" (input)="updateLinkField(platform, $event)" class="flex-grow p-2 bg-neutral-700 border-neutral-600 rounded-md">
                  </div>
                </div>
              </div>

              <!-- All other sections can be added here following the same pattern -->
              <!-- This is a simplified example. A full implementation would have forms for all sections. -->
               <div *ngIf="section.id !== 'basic' && section.id !== 'musical' && section.id !== 'expertise' && section.id !== 'social'" class="text-neutral-500">
                  <p>Section coming soon...</p>
                  <p>Imagine detailed forms here for {{ section.label }} to give S.M.U.V.E. even more context about your artistry.</p>
              </div>

            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>
