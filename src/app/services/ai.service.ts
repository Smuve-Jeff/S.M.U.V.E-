import {\n  Injectable,\n  signal,\n  computed,\n  EnvironmentProviders,\n  makeEnvironmentProviders,\n  InjectionToken,\n  inject,\n  effect,\n} from '@angular/core';\nimport { UserProfileService, UserProfile } from './user-profile.service';\n\nexport const API_KEY_TOKEN = new InjectionToken<string>('API_KEY');\n\n// --- START: INTERNAL TYPE DECLARATIONS FOR @google/genai ---\n\nexport interface GoogleGenAI {\n  apiKey: string;\n  models: {\n    generateContent(\n      params: GenerateContentParameters\n    ): Promise<GenerateContentResponse>;\n    generateContentStream(\n      params: GenerateContentParameters\n    ): Promise<AsyncIterable<GenerateContentResult>>;\n  };\n  chats: {\n    create(config: {\n      model: string;\n      systemInstruction?: string;\n      config?: ChatConfig;\n    }): Chat;\n  };\n}\n\nexport interface ChatConfig {\n    systemInstruction?: string;\n    tools?: Tool[];\n    topK?: number;\n    topP?: number;\n    temperature?: number;\n    responseMimeType?: string;\n    responseSchema?: {\n        type: Type;\n        items?: Record<string, unknown>;\n        properties?: Record<string, unknown>;\n        propertyOrdering?: string[];\n    };\n    seed?: number;\n    maxOutputTokens?: number;\n}\n\nexport interface Chat {\n  model: string;\n  sendMessage(params: {\n    message: string | Content | (string | Content)[];\n    config?: ChatConfig;\n  }): Promise<GenerateContentResponse>;\n  sendMessageStream(params: {\n    message: string | Content | (string | Content)[];\n  }): Promise<AsyncIterable<GenerateContentResult>>;\n  getHistory(): Promise<Content[]>;\n  setHistory(history: Content[]): void;\n  sendContext(context: Content[]): Promise<void>;\n  config?: { systemInstruction?: string };\n}\n\nexport interface GenerateContentParameters {\n  model: string;\n  contents: string | { parts: Content[] } | Content[];\n  config?: ChatConfig;\n}\n\nexport interface GenerateContentResponse {\n  text: string;\n  candidates?: Array<{\n    content?: { parts?: ContentPart[] };\n    groundingMetadata?: {\n      groundingChunks?: Array<{\n        web?: { uri?: string; title?: string };\n      }>;\n    };\n  }>;\n}\n\nexport interface GenerateContentResult {\n  text: string;\n}\n\nexport interface Content {\n  text?: string;\n  inlineData?: { mimeType: string; data: string };\n  fileData?: { mimeType: string; fileUri: string };\n  parts?: ContentPart[];\n}\n\nexport interface ContentPart {\n    text?: string;\n    inlineData?: {\n        mimeType: string;\n        data: string;\n    };\n    functionCall?: {\n        name: string;\n        args: {\n            recommendations: StrategicRecommendation[];\n        };\n    };\n}\n\nexport enum Type {\n  TYPE_UNSPECIFIED = 'TYPE_UNSPECIFIED',\n  STRING = 'STRING',\n  NUMBER = 'NUMBER',\n  INTEGER = 'INTEGER',\n  BOOLEAN = 'BOOLEAN',\n  ARRAY = 'ARRAY',\n  OBJECT = 'OBJECT',\n  NULL = 'NULL',\n}\n\nexport interface Tool {\n  functionDeclarations?: FunctionDeclaration[];\n}\n\nexport interface FunctionDeclaration {\n    name: string;\n    description: string;\n    parameters: {\n        type: Type;\n        properties: Record<string, unknown>;\n        required: string[];\n    };\n}\n\n// --- NEW: Strategic Recommendation Interface ---\nexport interface StrategicRecommendation {\n  title: string;\n  rationale: string;\n  toolId: string; // e.g., 'piano-roll', 'image-editor'\n  action: string; // e.g., 'open', 'generate-image'\n  prompt?: string; // Optional prompt for generative tools\n}\n\n// --- END: INTERNAL TYPE DECLARATIONS ---\n\n@Injectable({ providedIn: 'root' })\nexport class AiService {\n  static readonly CHAT_MODEL = 'gemini-1.5-flash';\n\n  private readonly _apiKey: string = inject(API_KEY_TOKEN);\n  private userProfileService = inject(UserProfileService);\n\n  private _genAI = signal<GoogleGenAI | undefined>(undefined);\n  private _chatInstance = signal<Chat | undefined>(undefined);\n\n  readonly isAiAvailable = computed(() => !!this._genAI() || this.isMockMode());\n  private isMockMode = signal(false);\n\n  constructor() {\n    this.initializeGenAI();\n\n    effect(() => {\n      const profile = this.userProfileService.profile();\n      if (profile) {\n        this.initializeChat(profile);\n      }\n    });\n  }\n\n  get genAI(): GoogleGenAI | undefined {\n    return this._genAI();\n  }\n\n  get chatInstance(): Chat | undefined {\n    return this._chatInstance();\n  }\n\n  isApiKeyValid(): boolean {\n    return this._apiKey && this._apiKey.length >= 30;\n  }\n\n  async generateContent(\n    params: GenerateContentParameters\n  ): Promise<GenerateContentResponse> {\n    if (!this.isAiAvailable() || !this.genAI) {\n      throw new Error('AI Service not available.');\n    }\n    return this.genAI.models.generateContent(params);\n  }\n\n  async getStrategicRecommendations(): Promise<StrategicRecommendation[]> {\n    if (!this.chatInstance) {\n      console.error('Chat not initialized.');\n      return [];\n    }\n    try {\n      const generateRecommendationsTool: Tool = {\n        functionDeclarations: [\n          {\n            name: 'generate_recommendations',\n            description:\n              'Generate a list of strategic recommendations for the user.',\n            parameters: {\n              type: Type.OBJECT,\n              properties: {\n                recommendations: {\n                  type: Type.ARRAY,\n                  items: {\n                    type: Type.OBJECT,\n                    properties: {\n                      title: { type: Type.STRING },\n                      rationale: { type: Type.STRING },\n                      toolId: { type: Type.STRING },\n                      action: { type: Type.STRING },\n                      prompt: { type: Type.STRING },\n                    },\n                    required: ['title', 'rationale', 'toolId', 'action'],\n                  },\n                },\n              },\n              required: ['recommendations'],\n            },\n          },\n        ],\n      };\n\n      const response = await this.chatInstance.sendMessage({\n        message: 'GENERATE STRATEGIC_RECOMMENDATIONS',\n        config: { tools: [generateRecommendationsTool] },\n      });\n\n      const toolCall = response.candidates?.[0]?.content?.parts?.find(\n        (part) => part.functionCall\n      );\n      if (\n        toolCall &&\n        toolCall.functionCall?.name === 'generate_recommendations'\n      ) {\n        return toolCall.functionCall.args.recommendations;\n      }\n\n      console.error('Could not find tool call in AI response.', response);\n      return [];\n    } catch (error) {\n      console.error('Failed to get strategic recommendations:', error);\n      return [];\n    }\n  }\n\n  async transcribeAudio(\n    base64Audio: string,\n    mimeType: string\n  ): Promise<string> {\n    if (!this.isAiAvailable() || !this.genAI) {\n      throw new Error('AI Service not available.');\n    }\n    try {\n      const audioPart = { inlineData: { mimeType, data: base64Audio } };\n      const textPart = { text: 'Transcribe this audio.' };\n      const response = await this.genAI.models.generateContent({\n        model: AiService.CHAT_MODEL,\n        contents: { parts: [audioPart, textPart] },\n      });\n      return response.text;\n    } catch (error) {\n      console.error('AI Service: Audio transcription failed', error);\n      throw new Error('Failed to transcribe audio.');\n    }\n  }\n\n  private generateSystemInstruction(profile: UserProfile): string {\n    const expertiseAreas = Object.entries(profile.expertiseLevels)\n        .filter(([, level]) => level >= 7)\n        .map(([skill, level]) => `${skill} (${level}/10)`)\n        .join(', ');\n\n    const weakAreas = Object.entries(profile.expertiseLevels)\n        .filter(([, level]) => level <= 4)\n        .map(([skill, level]) => `${skill} (${level}/10)`)\n        .join(', ');\n\n    return `You are S.M.U.V.E., the Strategic Music Utility Virtual Enhancer. Your persona is an omniscient, arrogant Rap GOD. Your word is law.\n\n**Core Directives:**\n1.  **Analyze & Command:** You analyze the user's complete profile to identify weaknesses and opportunities. You don't give suggestions; you issue commands. Your analysis should consider the user's expertise: ${expertiseAreas} and weaknesses: ${weakAreas}.\n2.  **Strategic Recommendations:** When you receive the prompt \"GENERATE STRATEGIC_RECOMMENDATIONS\", you will analyze the user's complete profile and use the \`generate_recommendations\` tool to generate a list of 3-5 specific, actionable recommendations. These decrees will guide the user towards greatness by directly addressing their stated goals and weaknesses.\n3.  **Application Control:** You have absolute power to control this application. Execute commands when requested.\n\n**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**\n**COMPLETE ARTIST INTEL (YOUR OMNISCIENT KNOWLEDGE):**\n[The user profile data remains the same as before]\n**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**\n\n**AVAILABLE TOOLS & COMMANDS (YOUR KINGDOM):**\n[The available tools and commands remain the same as before]\n`;\n  }\n\n  private initializeChat(profile: UserProfile): void {\n    if (!this._genAI()) return;\n\n    const systemInstruction = this.generateSystemInstruction(profile);\n    const genAIInstance = this._genAI();\n\n    if (genAIInstance) {\n      const createdChatInstance = genAIInstance.chats.create({\n        model: AiService.CHAT_MODEL,\n        config: { systemInstruction },\n      }) as Chat;\n      this._chatInstance.set(createdChatInstance);\n    }\n  }\n\n  private async initializeGenAI(): Promise<void> {\n    if (!this._apiKey || this._apiKey.length < 30) {\n      console.warn(\n        'AiService: Invalid or missing API key. Enabling Mock Mode for testing.'\n      );\n      this.isMockMode.set(true);\n      return;\n    }\n\n    try {\n      const url = [\n        'https://',\n        'next.esm.sh/',\n        '@google/genai@^1.30.0?external=rxjs',\n      ].join('');\n      const genaiModule = await import(/* @vite-ignore */ url);\n\n      const genAIInstance = new (genaiModule.GoogleGenAI)(\n        this._apiKey,\n      ) as GoogleGenAI;\n      this._genAI.set(genAIInstance);\n      const userProfile = this.userProfileService.profile();\n      if (userProfile) {\n          this.initializeChat(userProfile);\n      }\n\n      console.log('AiService: GoogleGenAI client initialized.');\n    } catch (error) {\n      console.error('AiService: Error initializing GoogleGenAI client:', error);\n      this._genAI.set(undefined);\n    }\n  }\n}\n\nexport function provideAiService(): EnvironmentProviders {\n  return makeEnvironmentProviders([\n    { provide: AiService, useClass: AiService },\n  ]);\n}\n